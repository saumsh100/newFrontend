<html>
<head>
    <link href="/fontawesome/fontawesome-all.css" rel="stylesheet" />
    <link href="/styles/style.css" rel="stylesheet">
</head>
<body>
    <div class="content">
        <header>
            <div id="avatar"></div>
            <div class="heading-wrapper">
                <h4 id="name"></h4>
                <h5 id="position"></h5>
            </div>
        </header>
        <ul class="container">
           <li id="user-profile">
               <i class="fal fa-user"></i>
               <p>User Profile</p>
               <i class="fal fa-external-link link-icon"></i>
           </li>
            <!--<li>-->
                <!--<i class="fal fa-exchange"></i>-->
                <!--<p>Switch User</p>-->
            <!--</li>-->
            <li id="logout-request">
                <i class="fal fa-power-off"></i>
                <p>Log Out</p>
            </li>
        </ul>
    </div>
</body>

<script>
  const { ipcRenderer, webFrame } = require('electron');
  const HIDE_DIALOG = 'HIDE_USER_MODAL';
  const SHOW_DIALOG = 'SHOW_USER_MODAL';
  const LOGOUT_REQUEST = 'LOGOUT_REQUEST';
  const SET_USER_DATA = 'SET_USER_DATA';
  const REQUEST_USER_DATA = 'REQUEST_USER_DATA';
  const OPEN_EXTERNAL_LINK = 'EXTERNAL_LINK';
  const REQUEST_ZOOM_FACTOR = 'REQUEST_ZOOM_FACTOR';
  const ZOOM_FACTOR_CHANGE = 'ZOOM_FACTOR_CHANGE';
  const REQUEST_HOST = 'REQUEST_HOST';
  const RESPONSE_HOST = 'RESPONSE_HOST';
  let storedUser = {};
  let hostUrl = null;

  document.addEventListener("mouseover", () => {
    ipcRenderer.send(SHOW_DIALOG);
  }, true);

  document.addEventListener("mouseout", () => {
    ipcRenderer.send(HIDE_DIALOG);
  }, true);

  document.getElementById('logout-request').onclick = () => {
    ipcRenderer.send(LOGOUT_REQUEST);
  };

  document.getElementById('user-profile').onclick = () => {
    ipcRenderer.send(OPEN_EXTERNAL_LINK, `${hostUrl}/profile`);
  };

  ipcRenderer.send(REQUEST_HOST);
  ipcRenderer.send(REQUEST_USER_DATA);

  ipcRenderer.on(SET_USER_DATA, (e, data) => {
    storedUser = data;
    renderUser();
  });

  ipcRenderer.on(RESPONSE_HOST, (e, data) => {
    hostUrl = data;
  });

  ipcRenderer.on(ZOOM_FACTOR_CHANGE, (e, data) => {
    webFrame.setZoomFactor(data);
  });

  ipcRenderer.send(REQUEST_ZOOM_FACTOR, { window: 'userModal' });

  const renderUser = () => {
    const { user, role } = storedUser;

    document.getElementById('name').innerText = user.firstName;
    document.getElementById('position').innerText = role;

    const url = user.fullAvatarUrl || user.avatarUrl;
    let contentDom = null;

    if (url) {
      contentDom = document.createElement('img');
      contentDom.src = url;
    }
    else {
      contentDom = document.createElement('span');
      contentDom.innerHTML = `${user.firstName && user.firstName[0]}${user.lastName && user.lastName[0]}`
    }
    document.getElementById('avatar').innerHTML = '';
    document.getElementById('avatar').appendChild(contentDom);
  }
</script>
</html>
